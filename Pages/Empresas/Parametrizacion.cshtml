@@page
@model IvaFacilitador.Pages.Empresas.ParametrizacionModel
@{
    ViewData["Title"] = "Parametrización de Empresa";
    var comunes = new[] { "Tarifa general 13", "Tarifa reducida 4", "Tarifa reducida 2", "Tarifa reducida 1", "0%/Exento/No sujeto" };
    var opciones = (Model.AvailableSalesTaxLabels ?? new List<string>())
                   .Concat(comunes)
                   .Distinct(StringComparer.OrdinalIgnoreCase)
                   .ToList();
}

<h2>Parametrización</h2>

@if (TempData["Error"] is string e) { <div class="alert alert-danger">@e</div> }
@if (TempData["Success"] is string s) { <div class="alert alert-success">@s</div> }

@if (Model.PendingCompany is null)
{
    <div class="alert alert-warning">No hay empresa pendiente.</div>
}
else
{
    <div class="card mb-3">
        <div class="card-body">
            <h5 class="card-title">Empresa</h5>
            <div><strong>RealmId:</strong> @Model.PendingCompany.RealmId</div>
            <div><strong>Nombre:</strong> @Model.PendingCompany.Name</div>
        </div>
    </div>

    <div class="mb-3">
        <h5>Tarifas detectadas automáticamente (últimos 90 días)</h5>
        @if (Model.DetectedSalesTariffs?.Count > 0)
        {
            <ul>
            @foreach (var t in Model.DetectedSalesTariffs) { <li>@t</li> }
            </ul>
        }
        else
        {
            <div class="text-muted">No se detectaron tarifas en documentos recientes. Puedes seleccionarlas manualmente abajo.</div>
        }
    </div>

    <form method="post">
        <div class="mb-3">
            <label class="form-label d-block">¿Estas tarifas detectadas son correctas?</label>
            <div class="form-check form-check-inline">
                <input class="form-check-input"
                       type="radio"
                       id="ok-si"
                       name="TariffsAreCorrect"
                       value="true"
                       @(Model.TariffsAreCorrect == true ? "checked" : "") />
                <label class="form-check-label" for="ok-si">Sí</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input"
                       type="radio"
                       id="ok-no"
                       name="TariffsAreCorrect"
                       value="false"
                       @(Model.TariffsAreCorrect == false ? "checked" : "") />
                <label class="form-check-label" for="ok-no">No, tengo otras</label>
            </div>
        </div>

        <div class="mb-3">
            <label class="form-label">Selecciona las tarifas adicionales que usas</label>
            <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 g-2">
            @foreach (var label in opciones)
            {
                var selected = (Model.ExtraTariffs?.Contains(label, StringComparer.OrdinalIgnoreCase) ?? false)
                               || (Model.DetectedSalesTariffs?.Contains(label, StringComparer.OrdinalIgnoreCase) ?? false);
                <div class="col">
                    <div class="form-check">
                        <input class="form-check-input"
                               type="checkbox"
                               id="chk_@label.GetHashCode()"
                               name="ExtraTariffs"
                               value="@label"
                               @(selected ? "checked" : "") />
                        <label class="form-check-label" for="chk_@label.GetHashCode()">@label</label>
                    </div>
                </div>
            }
            </div>
            <div class="form-text">
                Si no ves tu tarifa, puedes agregarla luego en QuickBooks; aquí solo homologamos a etiquetas estándar.
            </div>
        </div>

        <div class="d-flex gap-2">
            <button type="submit" formaction="?handler=Confirm" class="btn btn-primary">Confirmar</button>
            <button type="submit" formaction="?handler=Cancel"  class="btn btn-outline-danger">Cancelar</button>
        </div>
    </form>
}

