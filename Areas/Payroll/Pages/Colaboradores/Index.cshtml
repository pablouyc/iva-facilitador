@page
@model IvaFacilitador.Areas.Payroll.Pages.Colaboradores.IndexModel
@{
    ViewData["Title"] = "Colaboradores";
    ViewData["PayrollSection"] = "Colaboradores";

    var canAdd = Model.CompanyId.HasValue && Model.IsCompanyLinked;
    var isActivos = string.Equals(Model.Status, "activos", StringComparison.OrdinalIgnoreCase);
    var qActivos = Model.CompanyId.HasValue ? $"?companyId={Model.CompanyId}&status=activos" : "?status=activos";
    var qInactivos = Model.CompanyId.HasValue ? $"?companyId={Model.CompanyId}&status=inactivos" : "?status=inactivos";
}
@await Html.PartialAsync("~/Areas/Payroll/Components/_Topbar.cshtml")

<h1>Colaboradores</h1>

<!-- Barra de navegación de estado -->
<ul class="nav nav-pills mb-3">
  <li class="nav-item">
    <a class="nav-link @(isActivos ? "active" : "")" href="@qActivos">Activos</a>
  </li>
  <li class="nav-item">
    <a class="nav-link @(!isActivos ? "active" : "")" href="@qInactivos">Inactivos</a>
  </li>
</ul>

<!-- Acciones -->
<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    @if (Model.CompanyId.HasValue) {
      <span class="badge bg-secondary">EmpresaId: @Model.CompanyId</span>
    } else {
      <span class="text-muted">Seleccione una empresa en el header</span>
    }
  </div>

  <div>
    <button type="button" class="btn btn-primary" @(canAdd ? "" : "disabled") data-bs-toggle="modal" data-bs-target="#dlgAgregar">
      Agregar
    </button>
  </div>
</div>

<!-- Tabla de colaboradores -->
<div class="table-responsive">
  <table class="table table-striped align-middle">
    <thead>
      <tr>
        <th>Nombre</th>
        <th>Cédula</th>
        <th>Sector</th>
        <th>Cargo</th>
        <th>Salario mensual</th>
        <th>CCSS</th>
        <th>INS</th>
        <th>% Pago</th>
        <th>Estado</th>
        @if (!isActivos) { <th>Fecha baja</th> }
        <th style="width:1%"></th>
      </tr>
    </thead>
    <tbody>
    @if (Model.Rows.Count == 0)
    {
        <tr>
          <td colspan="@(isActivos ? 10 : 11)" class="text-muted">No hay colaboradores @(isActivos ? "activos" : "inactivos").</td>
        </tr>
    }
    else
    {
        @foreach (var row in Model.Rows)
        {
            <tr>
              <td>@row.Nombre</td>
              <td>@row.Cedula</td>
              <td>@row.Sector</td>
              <td>@row.Cargo</td>
              <td>@(row.SalarioMensual?.ToString("N2", System.Globalization.CultureInfo.GetCultureInfo("es-CR")) ?? "-")</td>
              <td>@(row.HasCcss ? "Sí" : "No")</td>
              <td>@(row.HasIns ? "Sí" : "No")</td>
              <td>@row.PorcentajePago</td>
              <td>@row.Estado</td>
              @if (!isActivos) { <td>@(row.EndDate?.ToString("yyyy-MM-dd") ?? "-")</td> }
              <td>
                <a class="btn btn-sm btn-outline-secondary" href="#" title="Editar">Editar</a>
              </td>
            </tr>
        }
    }
    </tbody>
  </table>
</div>

<!-- Modal Agregar (placeholder, se implementa en Iteración 7) -->
<div class="modal fade" id="dlgAgregar" tabindex="-1" aria-labelledby="dlgAgregarLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="dlgAgregarLabel">Agregar colaboradores</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
<!-- Selector de vistas -->
<div class="mb-3">
  <div class="btn-group" role="group" aria-label="Método de alta">
    <button type="button" class="btn btn-outline-primary active" data-view="qbo" id="btnViewQbo">QBO</button>
    <button type="button" class="btn btn-outline-primary" data-view="manual" id="btnViewManual">Manual</button>
    <button type="button" class="btn btn-outline-primary" data-view="excel" id="btnViewExcel">Excel</button>
  </div>
</div>

<!-- Vista QBO -->
<div id="view-qbo">
  <div class="alert alert-info" id="qboNotice" style="display:none;"></div>
  <div class="d-flex gap-2 mb-2">
    <button type="button" class="btn btn-secondary" id="btnFetchQbo">Traer de QBO</button>
    <div class="spinner-border spinner-border-sm text-secondary" role="status" id="qboSpinner" style="display:none;">
      <span class="visually-hidden">Cargando…</span>
    </div>
  </div>
  <div class="table-responsive" style="max-height: 350px; overflow:auto;">
    <table class="table table-sm table-striped" id="tblQbo">
      <thead>
        <tr>
          <th>Nombre</th><th>Email</th><th>Teléfono</th><th>Estado</th>
        </tr>
      </thead>
      <tbody>
        <tr><td colspan="4" class="text-muted">Sin datos. Presione “Traer de QBO”.</td></tr>
      </tbody>
    </table>
  </div>
</div>

<!-- Vista Manual -->
<div id="view-manual" class="d-none">
  <form id="frmManual" class="row g-3">
    <div class="col-md-3">
      <label class="form-label">Cédula</label>
      <input type="text" class="form-control" id="mnNationalId" maxlength="50" required />
    </div>
    <div class="col-md-3">
      <label class="form-label">Nombre</label>
      <input type="text" class="form-control" id="mnFirstName" required />
    </div>
    <div class="col-md-3">
      <label class="form-label">Apellido</label>
      <input type="text" class="form-control" id="mnLastName" required />
    </div>
    <div class="col-md-3">
      <label class="form-label">Fecha ingreso</label>
      <input type="date" class="form-control" id="mnJoinDate" />
    </div>

    <div class="col-md-4">
      <label class="form-label">Email</label>
      <input type="email" class="form-control" id="mnEmail" />
    </div>
    <div class="col-md-4">
      <label class="form-label">Teléfono</label>
      <input type="text" class="form-control" id="mnPhone" />
    </div>
    <div class="col-md-4">
      <label class="form-label">Salario mensual</label>
      <input type="number" class="form-control" id="mnSalary" step="0.01" min="0" />
    </div>

    <div class="col-md-4">
      <label class="form-label">Sector</label>
      <input type="text" class="form-control" id="mnSector" placeholder="(coincidir con sectores parametrizados)" />
    </div>
    <div class="col-md-4">
      <label class="form-label">Cargo</label>
      <input type="text" class="form-control" id="mnJob" />
    </div>
    <div class="col-md-4 d-flex align-items-end gap-3">
      <div class="form-check">
        <input class="form-check-input" type="checkbox" id="mnCcss">
        <label class="form-check-label" for="mnCcss">CCSS</label>
      </div>
      <div class="form-check">
        <input class="form-check-input" type="checkbox" id="mnIns">
        <label class="form-check-label" for="mnIns">INS</label>
      </div>
    </div>

    <div class="col-12">
      <label class="form-label">Porcentajes de pago (la suma debe ser 100)</label>
      <div class="row g-2">
        <div class="col-6 col-md-3">
          <input type="number" class="form-control pct" id="mnPct1" min="0" max="100" step="0.01" placeholder="%1" />
        </div>
        <div class="col-6 col-md-3">
          <input type="number" class="form-control pct" id="mnPct2" min="0" max="100" step="0.01" placeholder="%2" />
        </div>
        <div class="col-6 col-md-3">
          <input type="number" class="form-control pct" id="mnPct3" min="0" max="100" step="0.01" placeholder="%3" />
        </div>
        <div class="col-6 col-md-3">
          <input type="number" class="form-control pct" id="mnPct4" min="0" max="100" step="0.01" placeholder="%4" />
        </div>
      </div>
      <small class="text-muted">Mensual: use solo %1=100. Quincenal: use %1/%2 (p.ej. 50/50). Semanal: distribuya %1–%4. </small>
      <div class="mt-1">
        <span>Suma actual: </span>
        <span id="sumPct" class="badge bg-secondary">0</span>
      </div>
    </div>

    <div class="col-12">
      <button type="button" class="btn btn-primary" id="btnManualSubmit">Guardar (stub)</button>
      <span class="ms-2 text-muted">Crea/matchea en QBO y (aún) no persiste en BD.</span>
    </div>
  </form>

  <div class="mt-3" id="manualMsg" style="display:none;"></div>
</div>

<!-- Vista Excel -->
<div id="view-excel" class="d-none">
  <p class="text-muted">Cargue colaboradores de forma masiva. Use la plantilla (o genere una mínima aquí) y pegue el CSV debajo.</p>
  <div class="d-flex gap-2 mb-2">
    <button type="button" class="btn btn-outline-secondary" id="btnGenCsv">Descargar plantilla mínima</button>
    <button type="button" class="btn btn-primary" id="btnUploadCsv">Procesar CSV (stub)</button>
  </div>
  <textarea id="csvText" class="form-control" rows="8" placeholder="Encabezados esperados: NationalId,FirstName,LastName,Email,Phone"></textarea>
  <div class="mt-3" id="uploadMsg" style="display:none;"></div>
</div>

<script>
window.addEventListener('error', (e) => {
  try {
    console.error('[Colab] global error handler:', { message: e.message, filename: e.filename, lineno: e.lineno, colno: e.colno, error: e.error });
  } catch(_) {}
});
console.log('[Colab] boot: script tag parsed');

  const COMPANY_ID = @(Model.CompanyId ?? 0);
  const LINKED     = @(Model.IsCompanyLinked.ToString().ToLower());
  const SECTORS    = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.SectorNames ?? new List<string>{"General"}));
  const PERIOD     = "@(Model.Periodo ?? "Mensual")";
  const PCT_SLOTS  = (PERIOD === "Mensual" ? 1 : (PERIOD === "Quincenal" ? 2 : 4));
  console.log("[Colab] consts:", { COMPANY_ID, LINKED, PERIOD, PCT_SLOTS });
(() => {
  // --- helpers ---
  const qs  = (sel) => document.querySelector(sel);
  const qsa = (sel) => Array.from(document.querySelectorAll(sel));
  const show = (el) => el && (el.style.display = "");
  const hide = (el) => el && (el.style.display = "none");
  const addClass = (el, cls) => el && el.classList.add(cls);
  const remClass = (el, cls) => el && el.classList.remove(cls);

  // Vistas (pestañas)
  const views = { qbo: qs("#view-qbo"), manual: qs("#view-manual"), excel: qs("#view-excel") };
  function switchView(name) {
    Object.entries(views).forEach(([k,el]) => { if (!el) return; (k===name)? remClass(el,"d-none") : addClass(el,"d-none"); });
    qsa('[data-view]').forEach(b => (b.getAttribute('data-view')===name? addClass(b,"active") : remClass(b,"active")));
    if (name === "manual") setPctVisibility();
    if (name === "qbo") setQboReadyState();
  }

  // ---------- QBO ----------
  const btnFetchQbo = qs("#btnFetchQbo");
  const qboSpinner  = qs("#qboSpinner");
  const qboNotice   = qs("#qboNotice");
  const tblQboBody  = () => qs("#tblQbo tbody");
  let QBO_LIST = [];

  function setQboReadyState() {
    if (!COMPANY_ID || !LINKED) {
      show(qboNotice); qboNotice.className = "alert alert-warning";
      qboNotice.textContent = !COMPANY_ID ? "Seleccione una empresa en el header para habilitar QBO."
                                          : "Esta empresa no está vinculada a QBO.";
      if (btnFetchQbo) btnFetchQbo.disabled = true;
    } else {
      hide(qboNotice); if (btnFetchQbo) btnFetchQbo.disabled = false;
    }
  }

  async function fetchQboEmployees() {
    console.log("[Colab] fetchQboEmployees", { COMPANY_ID, LINKED });
    if (!COMPANY_ID || !LINKED) return;
    if (qboSpinner) show(qboSpinner);
    try {
      const url  = `/payroll/api/qbo/employees?companyId=${COMPANY_ID}&includeInactive=false`;
      const resp = await fetch(url, { method: "GET" });
      const data = await resp.json();
      const tb   = tblQboBody(); if (!tb) return;
      tb.innerHTML = "";
      if (!Array.isArray(data) || data.length === 0) {
        tb.innerHTML = `<tr><td colspan="4" class="text-muted">No se recibieron colaboradores desde QBO.</td></tr>`;
        return;
      }
      QBO_LIST = data;
      for (const e of data) {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${(e.displayName || "").trim()}</td>
                        <td>${e.email || ""}</td>
                        <td>${e.phone || ""}</td>
                        <td>${e.active === false ? "Inactivo" : "Activo"}</td>`;
        tb.appendChild(tr);
      }
    } catch (err) {
      const tb = tblQboBody(); if (tb) tb.innerHTML = `<tr><td colspan="4" class="text-danger">Error obteniendo QBO: ${err}</td></tr>`;
    } finally {
      if (qboSpinner) hide(qboSpinner);
    }
  }
  if (btnFetchQbo) btnFetchQbo.addEventListener("click", fetchQboEmployees);
  setQboReadyState();

  // ---------- Manual (stubs seguros para no romper) ----------
  function setPctVisibility(){ /* no-op base; tu versión avanzada puede vivir aquí si la necesitas */ }
  function addRow(){ /* no-op */ }
  function collectRows(){ return []; }
  async function saveRows(){ /* no-op */ }

  // ---------- Excel (deja tus handlers existentes si están fuera, esto no choca) ----------

  // Wiring de tabs + delegación de respaldo
  qsa('[data-view]').forEach(b => b.addEventListener('click', () => switchView(b.getAttribute('data-view'))));
  document.addEventListener('click', (ev) => {
    const t = ev.target.closest('[data-view]');
    if (t) { ev.preventDefault(); switchView(t.getAttribute('data-view')); }
    if (ev.target.closest('#btnFetchQbo')) { ev.preventDefault(); fetchQboEmployees(); }
  });

  // Vista por defecto
  switchView("qbo");
})();
</script>
<div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        <button type="button" class="btn btn-primary" disabled>Continuar</button>
      </div>
    </div>
  </div>
</div>



















