@page
@model IvaFacilitador.Areas.Payroll.Pages.Colaboradores.IndexModel
@using IvaFacilitador.Areas.Payroll.ModelosPayroll
@{
    ViewData["Title"] = "Colaboradores";
    // Si tu área tiene layout propio, déjalo así; si no, comenta la línea.
    Layout = "/Areas/Payroll/Pages/Shared/_Layout.cshtml";
}

<div class="d-flex align-items-center justify-content-between mb-3">
    <h2 class="mb-0">Colaboradores (@Model.CompanyName)</h2>

    <div class="d-flex gap-2">
        <div class="btn-group me-2" role="group" aria-label="Filtro estado">
            <a asp-page="./Index"
               asp-route-ShowInactive="false"
               class="btn btn-sm @(Model.ShowInactive ? "btn-outline-secondary" : "btn-primary")">
                Activos
            </a>
            <a asp-page="./Index"
               asp-route-ShowInactive="true"
               class="btn btn-sm @(Model.ShowInactive ? "btn-primary" : "btn-outline-secondary")">
                Inactivos
            </a>
        </div>

        <div class="dropdown">
            <button class="btn btn-success btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                Agregar
            </button>
            <ul class="dropdown-menu dropdown-menu-end">
                <li><a class="dropdown-item" href="#" data-open="#panel-manual">Manual</a></li>
                <li><a class="dropdown-item" href="#" data-open="#panel-qbo">QBO</a></li>
                <li><a class="dropdown-item" href="#" data-open="#panel-excel">Excel (CSV)</a></li>
            </ul>
        </div>
    </div>
</div>

@if (!string.IsNullOrEmpty(Model.FlashOk))
{
    <div class="alert alert-success">@Model.FlashOk</div>
}
@if (!string.IsNullOrEmpty(Model.FlashErr))
{
    <div class="alert alert-danger">@Model.FlashErr</div>
}

<!-- ===== Tabla de colaboradores ===== -->
@if (Model.Rows != null && Model.Rows.Any())
{
    <div class="table-responsive mb-4">
        <table class="table table-sm align-middle">
            <thead>
                <tr>
                    <th>Nombre</th>
                    <th>Cédula</th>
                    <th>Sector</th>
                    <th>Cargo</th>
                    <th class="text-end">Salario mensual</th>
                    <th>Periodo</th>
                    <th>Estado</th>
                    <th style="width:1%; white-space:nowrap;"></th>
                </tr>
            </thead>
            <tbody>
            @foreach (var r in Model.Rows)
            {
                <tr>
                    <td>@r.Name</td>
                    <td>@r.TaxId</td>
                    <td>@r.Sector</td>
                    <td>@r.Position</td>
                    <td class="text-end">@r.MonthlySalary?.ToString("N2")</td>
                    <td>@r.PayPeriod</td>
                    <td>
                        @if (r.Status == 0) { <span class="badge bg-success">Activo</span> }
                        else { <span class="badge bg-secondary">Inactivo</span> }
                    </td>
                    <td class="text-end">
                        <form method="post" asp-page-handler="SetStatus" class="d-inline">
                            <input type="hidden" name="id" value="@r.Id" />
                            <input type="hidden" name="status" value="@(r.Status == 0 ? 1 : 0)" />
                            <button type="submit" class="btn btn-sm @(r.Status==0 ? "btn-outline-danger" : "btn-outline-primary")">
                                @(r.Status==0 ? "Terminar" : "Reactivar")
                            </button>
                        </form>
                    </td>
                </tr>
            }
            </tbody>
        </table>
    </div>
}
else
{
    <p class="text-muted">No hay colaboradores para mostrar.</p>
}

<!-- ===== Panel: Agregar Manual (colapsado por defecto) ===== -->
<div id="panel-manual" class="card mb-4 d-none">
    <div class="card-header">Agregar colaborador manualmente</div>
    <div class="card-body">
        <form method="post" asp-page-handler="AddManual" class="row g-3">
            <input type="hidden" name="companyId" value="@Model.CompanyId" />
            <div class="col-md-4">
                <label asp-for="Manual.Name" class="form-label"></label>
                <input asp-for="Manual.Name" class="form-control" />
                <span asp-validation-for="Manual.Name" class="text-danger"></span>
            </div>
            <div class="col-md-4">
                <label asp-for="Manual.TaxId" class="form-label"></label>
                <input asp-for="Manual.TaxId" class="form-control" />
            </div>
            <div class="col-md-4">
                <label asp-for="Manual.MonthlySalary" class="form-label"></label>
                <input asp-for="Manual.MonthlySalary" type="number" step="0.01" class="form-control" />
            </div>

            <div class="col-md-4">
                <label asp-for="Manual.Sector" class="form-label"></label>
                <input asp-for="Manual.Sector" class="form-control" />
            </div>
            <div class="col-md-4">
                <label asp-for="Manual.Position" class="form-label"></label>
                <input asp-for="Manual.Position" class="form-control" />
            </div>
            <div class="col-md-4">
                <label asp-for="Manual.PayPeriod" class="form-label"></label>
                <select asp-for="Manual.PayPeriod"
                        class="form-select"
                        asp-items="Html.GetEnumSelectList<PayPeriod>()"></select>
            </div>

            <div class="col-md-3">
                <label asp-for="Manual.Split1" class="form-label">Split 1 (%)</label>
                <input asp-for="Manual.Split1" type="number" class="form-control" />
            </div>
            <div class="col-md-3">
                <label asp-for="Manual.Split2" class="form-label">Split 2 (%)</label>
                <input asp-for="Manual.Split2" type="number" class="form-control" />
            </div>
            <div class="col-md-3">
                <label asp-for="Manual.Split3" class="form-label">Split 3 (%)</label>
                <input asp-for="Manual.Split3" type="number" class="form-control" />
            </div>
            <div class="col-md-3">
                <label asp-for="Manual.Split4" class="form-label">Split 4 (%)</label>
                <input asp-for="Manual.Split4" type="number" class="form-control" />
            </div>

            <div class="col-md-3 form-check ms-2">
                <input asp-for="Manual.UseCCSS" class="form-check-input" />
                <label asp-for="Manual.UseCCSS" class="form-check-label">Paga CCSS</label>
            </div>
            <div class="col-md-3 form-check">
                <input asp-for="Manual.UseSeguro" class="form-check-input" />
                <label asp-for="Manual.UseSeguro" class="form-check-label">Paga seguro</label>
            </div>

            <div class="col-12">
                <button class="btn btn-primary">Agregar colaborador</button>
            </div>
        </form>
    </div>
</div>

<!-- ===== Panel: QBO (colapsado por defecto) ===== -->
<div id="panel-qbo" class="card mb-4 d-none">
    <div class="card-header">Importar desde QBO</div>
    <div class="card-body">
        <p class="text-muted">Traerá empleados activos (Id, DisplayName) desde QBO y los insertará si no existen.</p>
        <form method="post" asp-page-handler="ImportQbo" class="d-flex gap-2">
            <input type="hidden" name="companyId" value="@Model.CompanyId" />
            <button class="btn btn-secondary">Sincronizar ahora</button>
        </form>

        @if (Model.QboEmployees != null && Model.QboEmployees.Any())
        {
            <hr />
            <div class="table-responsive">
                <table class="table table-sm">
                    <thead><tr><th>Id</th><th>Nombre</th></tr></thead>
                    <tbody>
                    @foreach (var e in Model.QboEmployees)
                    {
                        <tr><td>@e.Id</td><td>@e.Name</td></tr>
                    }
                    </tbody>
                </table>
            </div>
        }
        else
        {
            <p class="text-muted mb-0">No se encontraron colaboradores en QBO o aún no se cargaron.</p>
        }
    </div>
</div>

<!-- ===== Panel: Excel/CSV (colapsado por defecto) ===== -->
<div id="panel-excel" class="card mb-4 d-none">
    <div class="card-header">Importar desde Excel (CSV)</div>
    <div class="card-body">
        <form method="post" asp-page-handler="UploadCsv" enctype="multipart/form-data" class="row g-3 align-items-end">
            <input type="hidden" name="companyId" value="@Model.CompanyId" />
            <div class="col-md-6">
                <label asp-for="Csv" class="form-label">Archivo CSV</label>
                <input asp-for="Csv" type="file" accept=".csv" class="form-control" />
                <span class="form-text">
                    <a asp-page-handler="DownloadCsvTemplate">Descargar plantilla</a>
                </span>
            </div>
            <div class="col-md-3">
                <button class="btn btn-primary">Importar</button>
            </div>
        </form>
    </div>
</div>

@section Scripts{
    <partial name="_ValidationScriptsPartial" />
    <script>
        // Abre paneles solo cuando se elige desde "Agregar"
        document.querySelectorAll('[data-open]').forEach(a => {
            a.addEventListener('click', function (e) {
                e.preventDefault();
                document.querySelectorAll('#panel-manual,#panel-qbo,#panel-excel').forEach(p => p.classList.add('d-none'));
                const sel = document.querySelector(this.dataset.open);
                if (sel) sel.classList.remove('d-none');
            });
        });
    </script>
}

