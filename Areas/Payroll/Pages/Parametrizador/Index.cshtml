@page "{id:int?}"
@model IvaFacilitador.Areas.Payroll.Pages.Parametrizador.IndexModel
@{
    ViewData["Title"] = "Parametrizador de nómina";
    var sectors = Model.SectorNames ?? new List<string> { "General" };

    string Selected(string row, string key) => Model.SelectedFor(row, key) ?? "";
    string SectorInputName(int i) => $"SectorName_{i}";
    string MapName(int i, string key) => $"Map_{i}_{key}";
}

<h1>Parametrizador de nómina</h1>

@if (TempData["ok"] is string ok && !string.IsNullOrWhiteSpace(ok))
{
    <div class="alert alert-success">@ok</div>
}

<form method="post" asp-page-handler="Save">
    <input type="hidden" name="CompanyId" value="@Model.CompanyId" />

    <div class="mb-3">
        <label class="form-label">Empresa</label>
        <input class="form-control" name="CompanyName" value="@(Model.CompanyName ?? "")" />
        <div class="form-text">REALMID (QBO): @(Model.RealmId ?? "—")</div>
    </div>

    <h5>Cuentas contables</h5>

    <div class="form-check mb-2">
        <input class="form-check-input" type="checkbox" id="SplitBySector" name="SplitBySector" @(Model.SplitBySector ? "checked" : "") />
        <label class="form-check-label" for="SplitBySector">Separar planilla contable por sectores</label>
    </div>

    <div class="mb-2">
        <label class="form-label">Sectores</label>
        <div class="text-muted">Puedes dejar solo “General” si no usarás sectores.</div>
    </div>

    <table class="table align-middle">
        <thead>
            <tr>
                <th style="width: 18%">Sector</th>
                <th>SalarioBruto</th>
                <th>Extras</th>
                <th>CCSS</th>
                <th>Deducciones</th>
                <th>SalarioNeto</th>
            </tr>
        </thead>
        <tbody>
        @{
            for (var i = 0; i < sectors.Count; i++)
            {
                var rowName = sectors[i];
        <tr>
            <td>
                <input class="form-control" name="@SectorInputName(i)" value="@rowName" />
            </td>

            <td>
                <select class="form-select" name="@MapName(i, "SalarioBruto")">
                    <option value="">(sin seleccionar)</option>
                    @foreach (var a in Model.Accounts)
                    {
                        var sel = Selected(rowName, "SalarioBruto") == a.Id;
                        if (sel)
                        {
                            <option value="@a.Id" selected>@a.Name</option>
                        }
                        else
                        {
                            <option value="@a.Id">@a.Name</option>
                        }
                    }
                </select>
            </td>

            <td>
                <select class="form-select" name="@MapName(i, "Extras")">
                    <option value="">(sin seleccionar)</option>
                    @foreach (var a in Model.Accounts)
                    {
                        var sel = Selected(rowName, "Extras") == a.Id;
                        if (sel)
                        {
                            <option value="@a.Id" selected>@a.Name</option>
                        }
                        else
                        {
                            <option value="@a.Id">@a.Name</option>
                        }
                    }
                </select>
            </td>

            <td>
                <select class="form-select" name="@MapName(i, "CCSS")">
                    <option value="">(sin seleccionar)</option>
                    @foreach (var a in Model.Accounts)
                    {
                        var sel = Selected(rowName, "CCSS") == a.Id;
                        if (sel)
                        {
                            <option value="@a.Id" selected>@a.Name</option>
                        }
                        else
                        {
                            <option value="@a.Id">@a.Name</option>
                        }
                    }
                </select>
            </td>

            <td>
                <select class="form-select" name="@MapName(i, "Deducciones")">
                    <option value="">(sin seleccionar)</option>
                    @foreach (var a in Model.Accounts)
                    {
                        var sel = Selected(rowName, "Deducciones") == a.Id;
                        if (sel)
                        {
                            <option value="@a.Id" selected>@a.Name</option>
                        }
                        else
                        {
                            <option value="@a.Id">@a.Name</option>
                        }
                    }
                </select>
            </td>

            <td>
                <select class="form-select" name="@MapName(i, "SalarioNeto")">
                    <option value="">(sin seleccionar)</option>
                    @foreach (var a in Model.Accounts)
                    {
                        var sel = Selected(rowName, "SalarioNeto") == a.Id;
                        if (sel)
                        {
                            <option value="@a.Id" selected>@a.Name</option>
                        }
                        else
                        {
                            <option value="@a.Id">@a.Name</option>
                        }
                    }
                </select>
            </td>
        </tr>
            }
        }
        </tbody>
    </table>

    <div class="mb-3">
        <label class="form-label">Nuevo sector</label>
        <input class="form-control" name="@SectorInputName(sectors.Count)" placeholder="(opcional) Escribe el nombre y guarda" />
    </div>

    <div class="mt-3">
        <button class="btn btn-primary" type="submit">Guardar</button>
        <a class="btn btn-secondary" href="/Payroll/Empresas">Volver</a>
    </div>
</form>

@section Scripts {
    <script>
        // Si no hay tokens, los combos vendrán vacíos. No hacemos llamada AJAX aquí.
        // Cuando existan tokens, el PageModel ya carga Accounts en GET.
    </script>
}
