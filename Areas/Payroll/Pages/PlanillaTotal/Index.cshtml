@page
@model IvaFacilitador.Areas.Payroll.Pages.PlanillaTotal.IndexModel
@{
    ViewData["Title"] = "Planilla total";
    ViewData["PayrollSection"] = "Planilla total";
}
@await Html.PartialAsync("~/Areas/Payroll/Components/_Topbar.cshtml")

@section Styles {
  <style>
    :root{
      --pt-brand: var(--verde, #02343F);
      --pt-ink: #0f172a;
      --pt-border: #e9eef2;
      --pt-border-strong: #dfe7ec;
      --pt-row: #fbfdfe;
      --pt-hover: rgba(2,52,63,.06);
      --pt-chip-extra-bg: rgba(2, 52, 63, .06);
      --pt-chip-extra-fg: #02343F;
      --pt-chip-ded-bg: rgba(220, 53, 69, .08);
      --pt-chip-ded-fg: #b02a37;
    }

    /* contenedor */
    .pt-wrap { position: relative; }

    /* tarjeta */
    .pt-wrap > .card{
      border: 1px solid var(--pt-border);
      border-radius: 14px;
      box-shadow: 0 6px 22px rgba(2,52,63,.08);
    }
    .pt-wrap > .card .card-body{ padding: 1rem 1rem 1.25rem; }

    /* meta (periodo, empresa) */
    .pt-meta{
      display:flex; gap:.75rem; align-items:center;
      margin-bottom:.75rem;
    }
    .pt-meta .badge{
      background: #fff; border:1px solid var(--pt-border);
      color: var(--pt-ink); font-weight:500; padding:.4rem .55rem;
      border-radius: 999px;
    }

    /* tabla */
    .pt-table-wrap{ overflow:auto; }
    .pt-table{ border-collapse: separate; border-spacing: 0; width: 100%; }
    .pt-table thead th{
      position: sticky; top: 0; z-index: 2;
      background: linear-gradient(180deg, rgba(2,52,63,.045), #fff 60%);
      color: var(--pt-brand);
      font-weight: 700; letter-spacing: .15px;
      border-bottom: 1px solid var(--pt-border-strong);
      backdrop-filter: saturate(1.2);
    }
    .pt-table th, .pt-table td{
      white-space: nowrap;
      border-top: 1px solid var(--pt-border);
    }
    .pt-table tbody tr:nth-child(even){ background: var(--pt-row); }
    .pt-table tbody tr:hover{
      background: var(--pt-hover);
      box-shadow: inset 0 1px 0 rgba(2,52,63,.06), inset 0 -1px 0 rgba(2,52,63,.06);
    }
    /* separadores verticales muy sutiles */
    .pt-table thead th + th,
    .pt-table tbody td + td{ box-shadow: inset 1px 0 0 var(--pt-border); }

    /* números alineados */
    .pt-cell-money{
      text-align:right; font-variant-numeric: tabular-nums;
    }
    .pt-cell-money.fw-semibold{ color: #0b5c6b; } /* neto */

    /* chips para enlaces de extras/deducciones */
    .pt-table .pop-extras,
    .pt-table .pop-deds{
      display:inline-block; padding:.15rem .45rem; border-radius:999px;
      text-decoration:none !important; line-height:1.25;
      border: 1px solid transparent;
    }
    .pt-table .pop-extras{
      background: var(--pt-chip-extra-bg); color: var(--pt-chip-extra-fg);
      border-color: rgba(2,52,63,.12);
    }
    .pt-table .pop-deds{
      background: var(--pt-chip-ded-bg); color: var(--pt-chip-ded-fg);
      border-color: rgba(220,53,69,.18);
    }
    .pt-table .pop-extras:focus, .pt-table .pop-deds:focus{
      outline: 0; box-shadow: 0 0 0 .2rem rgba(2,52,63,.12);
    }

    /* popovers Bootstrap */
    .popover{
      border:1px solid var(--pt-border);
      box-shadow: 0 14px 30px rgba(2,52,63,.18);
      border-radius: 10px;
    }
    .popover .popover-body{ font-size:.875rem; color: var(--pt-ink); }
  </style>
}
    .pt-table-wrap { overflow: auto; }
    .pt-table thead th { position: sticky; top: 0; background: #fff; z-index: 2; }
    .pt-table td, .pt-table th { white-space: nowrap; }
    .pt-meta { display: flex; gap: .75rem; align-items: center; margin-bottom: .75rem; }
    .pt-meta .badge { font-weight: 500; }
    .pt-cell-money { text-align: right; font-variant-numeric: tabular-nums; }
  </style>
}

<div class="pt-wrap">
  <div class="pt-meta">
    <span class="badge text-bg-light">Periodo: @Model.PeriodoLabel</span>
    @if (!string.IsNullOrWhiteSpace(Model.companyId))
    {
        <span class="badge text-bg-light">Empresa: @Model.companyId</span>
    }
  </div>

  <div class="card">
    <div class="card-body">
      <div class="pt-table-wrap">
        <table class="table table-sm table-hover align-middle pt-table">
          <thead>
            <tr>
              <th>Colaborador</th>
              <th>Identificación</th>
              <th>Cargo</th>
              <th>Sector</th>
              <th class="text-end">Salario mensual</th>
              <th class="text-end">Salario quincena</th>
              <th class="text-end">Extras</th>
              <th class="text-end">Salario bruto</th>
              <th class="text-end">Deducciones</th>
              <th class="text-end">Neto a recibir</th>
            </tr>
          </thead>
          <tbody>
          @for (var i = 0; i < Model.Rows.Count; i++)
          {
              var r = Model.Rows[i];
              <tr>
                <td>@r.Colaborador</td>
                <td>@r.Identificacion</td>
                <td>@r.Cargo</td>
                <td>@r.Sector</td>
                <td class="pt-cell-money">@Model.Money(r.SalarioMensual)</td>
                <td class="pt-cell-money">@Model.Money(r.SalarioQuincena)</td>
                <td class="pt-cell-money">
                  <a href="javascript:void(0)" class="link-dark text-decoration-none pop-extras" data-content-id="ex-@i">
                    @Model.Money(r.Extras)
                  </a>
                  <div id="ex-@i" class="d-none">
                    <div class="small">
                      @foreach (var it in r.ExtrasDetalle)
                      {
                        <div>@it.Name: <strong>@Model.Money(it.Amount)</strong></div>
                      }
                      @if (r.ExtrasDetalle.Count == 0)
                      {
                        <div class="text-muted fst-italic">Sin extras</div>
                      }
                    </div>
                  </div>
                </td>
                <td class="pt-cell-money">@Model.Money(r.Bruto)</td>
                <td class="pt-cell-money">
                  <a href="javascript:void(0)" class="link-dark text-decoration-none pop-deds" data-content-id="dd-@i">
                    @Model.Money(r.Deducciones)
                  </a>
                  <div id="dd-@i" class="d-none">
                    <div class="small">
                      @foreach (var it in r.DeduccionesDetalle)
                      {
                        <div>@it.Name: <strong>@Model.Money(it.Amount)</strong></div>
                      }
                      @if (r.DeduccionesDetalle.Count == 0)
                      {
                        <div class="text-muted fst-italic">Sin deducciones</div>
                      }
                    </div>
                  </div>
                </td>
                <td class="pt-cell-money fw-semibold">@Model.Money(r.Neto)</td>
              </tr>
          }
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

@section Scripts {
  <script>
    (function(){
      if (!window.bootstrap) return;
      function initPop(cls){
        document.querySelectorAll(cls).forEach(function(el){
          var id = el.getAttribute('data-content-id');
          var html = document.getElementById(id)?.innerHTML || '';
          var pop = bootstrap.Popover.getInstance(el);
          if (pop) pop.dispose();
          new bootstrap.Popover(el, { html: true, content: html, placement: 'top', trigger: 'hover focus' });
        });
      }
      initPop('.pop-extras');
      initPop('.pop-deds');
      document.addEventListener('ivapayroll:reinit-popovers', function(){ initPop('.pop-extras'); initPop('.pop-deds'); });
    })();
  </script>
}

